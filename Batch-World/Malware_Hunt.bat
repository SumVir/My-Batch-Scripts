@echo off
color 80
setlocal enabledelayedexpansion

REM Define log file
set LOGFILE=persistence_check_log.txt

REM Create or clear the log file
(
    echo ================================
    echo     Persistence Check Log
    echo         Date: %date%
    echo         Time: %time%
    echo ================================
) > %LOGFILE%

REM Define the set of persistence locations to check
set "locations[0]=HKCU\Software\Microsoft\Windows\CurrentVersion\Run"
set "locations[1]=HKLM\Software\Microsoft\Windows\CurrentVersion\Run"
set "locations[2]=HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce"
set "locations[3]=HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce"
set "locations[4]=HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run"
set "locations[5]=HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run"

REM Check each location
for /L %%i in (0,1,5) do (
    echo --------------------------------------------------- >> %LOGFILE%
    echo Checking: !locations[%%i]! >> %LOGFILE%
    echo --------------------------------------------------- >> %LOGFILE%
    reg query "!locations[%%i]!" >> %LOGFILE% 2>&1
    if errorlevel 1 (
        echo Status: No entries found in !locations[%%i]! >> %LOGFILE%
    ) else (
        echo Status: Entries found in !locations[%%i]! >> %LOGFILE%
    )
)

REM Check startup folders
set "startupFolder=%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup"
echo --------------------------------------------------- >> %LOGFILE%
echo Checking Startup folder: %startupFolder% >> %LOGFILE%
echo --------------------------------------------------- >> %LOGFILE%
dir "%startupFolder%" >> %LOGFILE% 2>&1
if errorlevel 1 (
    echo Status: No files found in Startup folder. >> %LOGFILE%
) else (
    echo Status: Files found in Startup folder. >> %LOGFILE%
)

REM Completion message
(
    echo ---------------------------------------------------
    echo Persistence check completed.
    echo Check %LOGFILE% for details.
    echo ================================
) >> %LOGFILE%

endlocal
exit /b